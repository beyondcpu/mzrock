use strict;
use Getopt::Long;

$INSTALLDIR="C:\\mzRock\\bin";
$REXECUTABLE="C:\\Program Files\\R\\R-2.7.0\\bin\\R.exe";
$RAW2MZCSV="$INSTALLDIR\\raw2mzCSV.exe";
$RSCRIPT="$INSTALLDIR\\mzRock.auto.R";


my %OPT; &GetOptions(\%OPT, "projectfolder:s");

my $PROJECTFOLDER = $OPT{'projectfolder'};
if ( not -d $PROJECTFOLDER ) { die "Could not find $PROJECTFOLDER\n"; }
open(LOG, ">$PROJECTFOLDER/log.txt") or warn "Can't write to $PROJECTFOLDER\log.txt";
chdir($PROJECTFOLDER) or die "Can't change to dir $PROJECTFOLDER\n";
opendir(DIR, ".") or die "Can't read files from $PROJECTFOLDER\n";

foreach my $filename (readdir(DIR)) { 
	next unless ( $filename  =~ /raw$/i );
	
	my $id = $filename; 
	$id =~ s/\.raw$//i;
	
	my $mzCSVFile = "$id.mzCSV";
	print LOG "Writing $mzCSVFile\n";
	
	system "$RAW2MZCSV \"$filename\" >  $mzCSVFile";	
}

#execute R
system("\"$REXECUTABLE\" BATCH --no-save < $RSCRIPT");

close(LOG);
close(DIR);
